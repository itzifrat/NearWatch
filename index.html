<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NearWatch | P2P Encrypted</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --bg-dark: #0b0e14; --primary: #6366f1; }
        body { background-color: var(--bg-dark); color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .video-wrapper { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#000; }
        .video-container { position:relative; width:100%; aspect-ratio:16/9; max-height:80vh; background:black; overflow:hidden; }
        .video-container iframe, .video-container video { position:absolute; top:0; left:0; width:100%; height:100%; outline:none; }
        .fade-in { animation:fadeIn .5s ease-out; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .avatar-option { transition:all .2s; cursor:pointer; opacity:.7; transform:scale(.95); }
        .avatar-option:hover { opacity:1; transform:scale(1.05); }
        .avatar-option.selected { opacity:1; transform:scale(1.15); border-color:var(--primary); box-shadow:0 0 15px rgba(99,102,241,.6); }
        ::-webkit-scrollbar{width:4px} ::-webkit-scrollbar-track{background:var(--bg-dark)} ::-webkit-scrollbar-thumb{background:#334155;border-radius:2px}
        .quote-fade { animation:fadeInOut 8s infinite; }
        @keyframes fadeInOut { 0%,100%{opacity:0} 10%,90%{opacity:1} }
        .glass-panel { background:rgba(21,25,35,.9); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,.06); }
        .spin { animation:spin 1s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* Debug log */
        #dbg { font-family:monospace; font-size:10px; line-height:1.6; max-height:90px; overflow-y:auto; }
        #dbg .ok  { color:#34d399 }
        #dbg .err { color:#f87171 }
        #dbg .inf { color:#93c5fd }
        #dbg .wrn { color:#fbbf24 }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

<div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[200] flex flex-col gap-2 pointer-events-none"></div>

<!-- Settings Modal -->
<dialog id="settings-modal" class="bg-transparent p-0 backdrop:bg-black/80 w-full max-w-md m-auto">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl p-6 text-white mx-4">
        <div class="flex justify-between items-center mb-5">
            <h2 class="text-xl font-bold">âš™ï¸ Settings</h2>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white text-xl">âœ•</button>
        </div>
        <div class="space-y-5">
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Profile</label>
                <div class="flex items-center gap-3 mb-3">
                    <div id="modal-avatar-preview" class="w-14 h-14 rounded-full bg-indigo-600 flex items-center justify-center text-2xl">ğŸ‘¾</div>
                    <input type="text" id="modal-username" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500" placeholder="Display Name">
                </div>
                <div class="grid grid-cols-5 gap-2 p-2 bg-slate-800/50 rounded-xl border border-slate-700/50">
                    <button onclick="pickAvatar('ğŸ‘¾','bg-indigo-600')" class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center hover:scale-110 transition mx-auto">ğŸ‘¾</button>
                    <button onclick="pickAvatar('ğŸ±','bg-purple-600')" class="h-10 w-10 rounded-full bg-purple-600 flex items-center justify-center hover:scale-110 transition mx-auto">ğŸ±</button>
                    <button onclick="pickAvatar('ğŸ¤–','bg-emerald-600')" class="h-10 w-10 rounded-full bg-emerald-600 flex items-center justify-center hover:scale-110 transition mx-auto">ğŸ¤–</button>
                    <button onclick="pickAvatar('ğŸ¦Š','bg-orange-600')" class="h-10 w-10 rounded-full bg-orange-600 flex items-center justify-center hover:scale-110 transition mx-auto">ğŸ¦Š</button>
                    <button onclick="pickAvatar('ğŸ‘»','bg-pink-600')" class="h-10 w-10 rounded-full bg-pink-600 flex items-center justify-center hover:scale-110 transition mx-auto">ğŸ‘»</button>
                </div>
            </div>
            <div id="host-settings-group" class="hidden pt-4 border-t border-slate-800 space-y-3">
                <label class="block text-[10px] font-bold text-slate-500 uppercase">Room Security</label>
                <div class="flex items-center justify-between"><span class="text-sm">Lock Room</span>
                    <button id="btn-lock-room" onclick="toggleRoomLock()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors"><div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div></button></div>
                <div class="flex items-center justify-between"><span class="text-sm">Host-Only Controls</span>
                    <button id="btn-host-only" onclick="toggleHostOnly()" class="w-10 h-5 rounded-full bg-slate-700 relative transition-colors"><div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform"></div></button></div>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">AI Key</label>
                <input type="password" id="ai-api-key" placeholder="Gemini API Key" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs outline-none focus:border-purple-500">
            </div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-lg font-bold text-sm transition">Save</button>
            <p class="text-center text-[10px] text-slate-600">NearWatch v4.0 â€¢ Â© Efrat Al Ahad</p>
        </div>
    </div>
</dialog>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop')] bg-cover bg-center">
    <div class="absolute inset-0 bg-black/85 backdrop-blur-sm"></div>

    <div class="relative glass-panel p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 fade-in">
        <div class="text-center mb-6">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 w-14 h-14 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                <i data-lucide="monitor-play" class="text-white w-7 h-7"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">NearWatch</h1>
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-bold uppercase">
                <i data-lucide="shield-check" class="w-3 h-3"></i> P2P Encrypted
            </span>
        </div>

        <!-- Avatar picker -->
        <div class="flex justify-center gap-3 mb-6">
            <div class="avatar-option w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ğŸ‘¾','bg-indigo-600')">ğŸ‘¾</div>
            <div class="avatar-option w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ğŸ±','bg-purple-600')">ğŸ±</div>
            <div class="avatar-option w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ğŸ¤–','bg-emerald-600')">ğŸ¤–</div>
            <div class="avatar-option w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center text-lg border-2 border-transparent" onclick="selectAvatar('ğŸ¦Š','bg-orange-600')">ğŸ¦Š</div>
        </div>

        <div class="space-y-3">
            <!-- Name -->
            <input type="text" id="username-input" placeholder="Your display name" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none text-sm placeholder-slate-500">

            <!-- Mode tabs -->
            <div class="grid grid-cols-2 gap-1 p-1 bg-[#0f1218] rounded-xl border border-slate-800">
                <button onclick="switchMode('create')" id="btn-mode-create" class="py-2 text-xs font-bold rounded-lg bg-indigo-600 text-white">Create Room</button>
                <button onclick="switchMode('join')"   id="btn-mode-join"   class="py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white">Join Room</button>
            </div>

            <!-- Create -->
            <div id="create-group">
                <div class="relative">
                    <input type="text" id="create-id-input" placeholder="Room ID (leave blank = random)" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl pl-4 pr-10 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none text-sm placeholder-slate-500">
                    <button onclick="fillRandom()" class="absolute right-3 top-3 text-slate-500 hover:text-indigo-400"><i data-lucide="dices" class="w-5 h-5"></i></button>
                </div>
            </div>

            <!-- Join -->
            <div id="join-group" class="hidden">
                <input type="text" id="join-id-input" placeholder="Enter Room ID to join" class="w-full bg-[#0f1218] border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none text-sm placeholder-slate-500">
            </div>

            <!-- Status box -->
            <div id="status-box" class="hidden bg-black/40 border border-slate-800 rounded-xl p-3 space-y-2">
                <div class="flex items-center gap-2">
                    <svg id="spinner" class="spin w-3.5 h-3.5 text-indigo-400 shrink-0 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10" stroke-dasharray="31.4" stroke-dashoffset="10"/></svg>
                    <span id="status-msg" class="text-xs text-slate-400 font-medium"></span>
                </div>
                <div id="dbg"></div>
            </div>

            <!-- Main CTA -->
            <button id="action-btn" onclick="handleStart()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg transition text-sm uppercase tracking-wide">
                Create Room
            </button>
            <button id="retry-btn" onclick="handleStart()" class="hidden w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-bold py-2.5 rounded-xl text-sm flex items-center justify-center gap-2 transition">
                ğŸ”„ Retry Connection
            </button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app-view" class="flex flex-col h-full hidden bg-[#0b0e14]">
    <header class="h-14 border-b border-slate-800 flex items-center justify-between px-4 z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="monitor-play" class="text-white w-4 h-4"></i></div>
            <span class="hidden sm:block font-bold text-white text-sm">NearWatch</span>
        </div>
        <div class="flex items-center gap-2 bg-[#151923] border border-slate-800 rounded-full px-3 py-1 cursor-pointer" onclick="copyId()">
            <span id="sync-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            <span id="my-peer-id" class="font-mono text-[10px] text-slate-400 max-w-[120px] truncate">...</span>
            <i data-lucide="copy" class="w-3 h-3 text-slate-500"></i>
            <div id="room-locked-indicator" class="hidden"><i data-lucide="lock" class="w-3 h-3 text-red-400"></i></div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleMobileChat()" class="lg:hidden text-slate-400 hover:text-white relative">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span id="chat-badge" class="absolute -top-1 -right-1 w-2 h-2 bg-indigo-500 rounded-full hidden"></span>
            </button>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white"><i data-lucide="settings" class="w-5 h-5"></i></button>
            <div id="user-avatar-display" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm cursor-pointer" onclick="toggleSettings()">?</div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- Video column -->
        <div class="flex-1 flex flex-col">
            <!-- Floating URL bar -->
            <div class="absolute top-16 left-1/2 -translate-x-1/2 w-[95%] max-w-2xl z-20 opacity-0 hover:opacity-100 focus-within:opacity-100 transition duration-300">
                <div class="flex gap-2 bg-[#151923]/95 backdrop-blur p-1.5 rounded-xl border border-slate-700 shadow-2xl">
                    <input type="text" id="url-input" placeholder="Paste YouTube or MP4 URLâ€¦" class="flex-1 bg-transparent text-xs text-white outline-none pl-2 placeholder-slate-500">
                    <button onclick="loadVideo()" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded-lg text-xs font-bold text-white transition">Play</button>
                    <div class="w-px bg-slate-700"></div>
                    <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-1 bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg text-xs text-white border border-slate-700 transition">
                        <i data-lucide="file-video" class="w-3 h-3 text-emerald-400"></i><span class="hidden sm:inline">File</span>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept="video/*" onchange="handleFile(this)">
                </div>
            </div>

            <!-- Video -->
            <div class="flex-1 bg-black flex items-center justify-center">
                <div class="video-wrapper">
                    <div id="video-box" class="video-container">
                        <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-[#0b0e14] z-10">
                            <i data-lucide="film" class="w-16 h-16 mb-4 opacity-20 text-slate-400"></i>
                            <p class="font-bold text-white">Ready to watch</p>
                            <p class="text-xs text-slate-500 mt-1">Hover top to load video</p>
                        </div>
                        <video id="html5-player" class="hidden" controls playsinline crossorigin="anonymous">
                            <track id="player-track" kind="subtitles" srclang="en" label="English" default>
                        </video>
                        <div id="youtube-player" class="hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Controls bar -->
            <div class="bg-[#151923] border-t border-slate-800 px-4 py-3 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-4">
                    <button onclick="seekRelative(-10)" class="text-slate-400 hover:text-white transition"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button>
                    <button onclick="seekRelative(10)"  class="text-slate-400 hover:text-white transition"><i data-lucide="rotate-cw"  class="w-5 h-5"></i></button>
                    <select id="speed-select" onchange="changeSpeed(this.value)" class="bg-[#0b0e14] text-slate-300 text-xs border border-slate-700 rounded px-2 py-1 outline-none">
                        <option value="0.5">0.5Ã—</option><option value="1" selected>1.0Ã—</option>
                        <option value="1.25">1.25Ã—</option><option value="1.5">1.5Ã—</option><option value="2">2.0Ã—</option>
                    </select>
                    <button onclick="document.getElementById('sub-input').click()" class="text-slate-400 hover:text-white transition"><i data-lucide="captions" class="w-5 h-5"></i></button>
                    <input type="file" id="sub-input" accept=".vtt,.srt" class="hidden" onchange="handleSubtitle(this)">
                </div>
                <p id="quote-text" class="hidden md:block text-xs text-slate-500 italic quote-fade">Watch together. No limits.</p>
                <button onclick="toggleFullscreen()" class="text-slate-400 hover:text-white transition"><i data-lucide="maximize" class="w-5 h-5"></i></button>
            </div>
        </div>

        <!-- Chat sidebar -->
        <div id="chat-sidebar" class="fixed inset-y-0 right-0 z-30 w-80 bg-[#151923] border-l border-slate-800 flex flex-col transform translate-x-full lg:translate-x-0 lg:static transition-transform duration-300">
            <button onclick="toggleMobileChat()" class="lg:hidden absolute top-3 right-3 p-1 text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="flex border-b border-slate-800 mt-10 lg:mt-0">
                <button onclick="switchTab('chat')"  id="tab-chat"  class="w-1/2 py-3 text-xs font-bold text-indigo-400 border-b-2 border-indigo-500">Chat</button>
                <button onclick="switchTab('users')" id="tab-users" class="w-1/2 py-3 text-xs font-bold text-slate-500 flex items-center justify-center gap-1">
                    Users <span id="user-count" class="text-[9px] bg-slate-800 px-1.5 py-0.5 rounded-full">1</span>
                </button>
            </div>
            <div id="view-chat" class="flex-1 flex flex-col overflow-hidden bg-[#0b0e14]">
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div class="text-center text-[10px] text-slate-600 uppercase tracking-widest font-bold">â€” Room Created â€”</div>
                </div>
                <div class="p-3 bg-[#151923] border-t border-slate-800">
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-1">
                        <button onclick="sendEmoji('ğŸ‘‹')" class="text-xl hover:scale-110 transition">ğŸ‘‹</button>
                        <button onclick="sendEmoji('ğŸ˜‚')" class="text-xl hover:scale-110 transition">ğŸ˜‚</button>
                        <button onclick="sendEmoji('ğŸ”¥')" class="text-xl hover:scale-110 transition">ğŸ”¥</button>
                        <button onclick="sendEmoji('ğŸ˜®')" class="text-xl hover:scale-110 transition">ğŸ˜®</button>
                        <button onclick="sendEmoji('â¤ï¸')" class="text-xl hover:scale-110 transition">â¤ï¸</button>
                        <button onclick="askAI('Suggest a movie')" class="ml-auto whitespace-nowrap text-[10px] bg-purple-500/10 text-purple-300 px-2.5 py-1 rounded-full border border-purple-500/20 hover:bg-purple-500/20 transition">âœ¨ AI Idea</button>
                    </div>
                    <form onsubmit="sendChat(event)" class="relative">
                        <input id="chat-input" type="text" placeholder="Messageâ€¦" class="w-full bg-[#0b0e14] border border-slate-700 rounded-xl py-3 pl-4 pr-10 text-xs text-white focus:border-indigo-500 outline-none placeholder-slate-600">
                        <button type="submit" class="absolute right-2 top-2.5 text-slate-400 hover:text-indigo-400"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                    </form>
                </div>
            </div>
            <div id="view-users" class="flex-1 hidden overflow-y-auto p-4 bg-[#0b0e14]">
                <p class="text-[10px] font-bold text-slate-500 uppercase mb-4">Participants</p>
                <div id="user-list-container" class="space-y-2"></div>
            </div>
        </div>
    </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â”€â”€â”€ PeerJS CDNs (tried in order) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PEERJS_CDNS = [
    'https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js',
    'https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js',
];

// â”€â”€â”€ ICE configs (tried in order, escalating from STUN â†’ TURN) â”€â”€
//
//  WHY THIS ORDER:
//  Config 0 â€“ basic STUN only (works if both peers are on same NAT or open internet)
//  Config 1 â€“ multiple Google STUN servers (helps with some symmetric NAT)
//  Config 2 â€“ adds free Metered/Open Relay TURN (fixes the "hostConn open timeout")
//  Config 3 â€“ TURN only, forces relay (always works, slightly higher latency)
//
const ICE_CONFIGS = [
    // 0: Minimal STUN
    { iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
    ]},
    // 1: Multiple STUN
    { iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' },
    ]},
    // 2: STUN + Free TURN (Open Relay Project)
    { iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'turn:openrelay.metered.ca:80',       username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443',      username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turns:openrelay.metered.ca:443',     username: 'openrelayproject', credential: 'openrelayproject' },
    ]},
    // 3: TURN relay only (most reliable, always works)
    { iceTransportPolicy: 'relay',
      iceServers: [
        { urls: 'turn:openrelay.metered.ca:80',       username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443',      username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turns:openrelay.metered.ca:443',     username: 'openrelayproject', credential: 'openrelayproject' },
    ]},
];

// Current ICE config index (escalates on failure)
let iceIdx = 0;

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let peer, connections = [], hostConn = null;
let isSyncing = false, apiKey = '';
let connTimeout = null, retryCount = 0;
const MAX_CONN_RETRIES = ICE_CONFIGS.length - 1;
let userList = [];
const quotes = ['Watch together. No limits.','Tonight, we\'re not alone.','Distance shouldn\'t pause the movie.','Same screen. Same moment.','Turn loneliness into togetherness.'];
const genId = () => Math.random().toString(36).slice(2, 8);

const S = {
    mode: 'create', id: null, username: 'Guest', avatar: 'ğŸ‘¾', color: 'bg-indigo-600',
    hostOnly: false, isLocked: false, maxUsers: 10, isCoHost: false, targetHostId: null,
    video: { type: null, src: null, time: 0, state: 'paused', speed: 1 }, ytPlayer: null
};

// Audio
const actx = new (window.AudioContext || window.webkitAudioContext)();
function ping() {
    if (actx.state === 'suspended') actx.resume();
    const o = actx.createOscillator(), g = actx.createGain();
    o.connect(g); g.connect(actx.destination);
    o.type = 'sine'; o.frequency.setValueAtTime(500, actx.currentTime);
    o.frequency.exponentialRampToValueAtTime(900, actx.currentTime + .12);
    g.gain.setValueAtTime(.07, actx.currentTime); g.gain.exponentialRampToValueAtTime(.001, actx.currentTime + .15);
    o.start(); o.stop(actx.currentTime + .15);
}

// â”€â”€â”€ Debug panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type = 'inf') {
    console.log(`[NW][${type}] ${msg}`);
    const p = document.getElementById('dbg'); if (!p) return;
    const d = document.createElement('div');
    d.className = type; d.textContent = 'â€º ' + msg;
    p.appendChild(d); p.scrollTop = p.scrollHeight;
}

// â”€â”€â”€ PeerJS loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadScript(src) {
    return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src; s.onload = res; s.onerror = rej;
        document.head.appendChild(s);
    });
}
async function ensurePeerJS() {
    if (typeof Peer !== 'undefined') return true;
    for (const cdn of PEERJS_CDNS) {
        try { log(`Loading PeerJS from ${new URL(cdn).hostname}â€¦`); await loadScript(cdn); if (typeof Peer !== 'undefined') { log('PeerJS loaded âœ“','ok'); return true; } }
        catch (e) { log(`CDN failed: ${new URL(cdn).hostname}`, 'err'); }
    }
    return false;
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
    lucide.createIcons();
    loadProfile();
    startQuotes();
    const p = new URLSearchParams(location.search);
    if (p.get('join')) { switchMode('join'); document.getElementById('join-id-input').value = p.get('join'); }
    ensurePeerJS(); // preload
};
function startQuotes() {
    let i = 0;
    setInterval(() => {
        const el = document.getElementById('quote-text'); if (!el) return;
        i = (i+1) % quotes.length;
        el.classList.remove('quote-fade'); void el.offsetWidth;
        el.textContent = quotes[i]; el.classList.add('quote-fade');
    }, 8000);
}
function loadProfile() {
    const s = localStorage.getItem('nw_profile'); if (!s) { selectAvatar('ğŸ‘¾','bg-indigo-600',true); pickAvatar('ğŸ‘¾','bg-indigo-600'); return; }
    const p = JSON.parse(s);
    document.getElementById('username-input').value = p.name || '';
    document.getElementById('modal-username').value = p.name || '';
    selectAvatar(p.avatar||'ğŸ‘¾', p.color||'bg-indigo-600', true);
    pickAvatar(p.avatar||'ğŸ‘¾', p.color||'bg-indigo-600');
    apiKey = p.apiKey || ''; document.getElementById('ai-api-key').value = apiKey;
}

// â”€â”€â”€ Login UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMode(m) {
    S.mode = m;
    const on  = 'py-2 text-xs font-bold rounded-lg bg-indigo-600 text-white';
    const off = 'py-2 text-xs font-bold rounded-lg text-slate-400 hover:text-white hover:bg-slate-800';
    document.getElementById('btn-mode-create').className = m==='create'?on:off;
    document.getElementById('btn-mode-join').className   = m==='join'  ?on:off;
    document.getElementById('action-btn').textContent    = m==='create'?'Create Room':'Join Room';
    document.getElementById('create-group').classList.toggle('hidden', m!=='create');
    document.getElementById('join-group').classList.toggle('hidden',   m!=='join');
    lucide.createIcons();
}
function fillRandom() { document.getElementById('create-id-input').value = genId(); }
function selectAvatar(av, col, login=false) {
    if (!login) return;
    S.avatar=av; S.color=col;
    document.querySelectorAll('.avatar-option').forEach(el => el.classList.toggle('selected', el.textContent.trim()===av));
}
function pickAvatar(av, col) {
    S.avatar=av; S.color=col;
    const p=document.getElementById('modal-avatar-preview');
    p.textContent=av; p.className=`w-14 h-14 rounded-full ${col} flex items-center justify-center text-2xl`;
}

function setStatus(msg, type='inf') {
    document.getElementById('status-box').classList.remove('hidden');
    document.getElementById('status-msg').textContent = msg;
    document.getElementById('status-msg').className = `text-xs font-medium ${type==='err'?'text-red-400':type==='ok'?'text-emerald-400':'text-slate-400'}`;
    document.getElementById('spinner').classList.toggle('hidden', type==='err'||type==='ok');
    log(msg, type);
}
function resetUI(errMsg='') {
    const btn=document.getElementById('action-btn');
    btn.disabled=false; btn.textContent=S.mode==='create'?'Create Room':'Join Room';
    document.getElementById('spinner').classList.add('hidden');
    if (errMsg) { setStatus(errMsg,'err'); toast(errMsg,'error'); document.getElementById('retry-btn').classList.remove('hidden'); lucide.createIcons(); }
}

// â”€â”€â”€ Main entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleStart() {
    const name = document.getElementById('username-input').value.trim();
    if (!name) return toast('Enter a display name','error');
    S.username = name;
    localStorage.setItem('nw_profile', JSON.stringify({name, avatar:S.avatar, color:S.color, apiKey}));

    document.getElementById('action-btn').disabled = true;
    document.getElementById('action-btn').textContent = 'Connectingâ€¦';
    document.getElementById('retry-btn').classList.add('hidden');
    document.getElementById('dbg').innerHTML = '';
    setStatus('Loading PeerJSâ€¦');

    if (!await ensurePeerJS()) { resetUI('Failed to load PeerJS library.'); return; }

    if (peer) { try { peer.destroy(); } catch(e){} peer=null; }
    connections=[]; hostConn=null; retryCount=0; iceIdx=0;

    if (S.mode==='create') {
        S.id = (document.getElementById('create-id-input').value.trim().replace(/[^a-zA-Z0-9-_]/g,'')||genId());
        S.isCoHost=true; S.hostOnly=false; S.isLocked=false; S.targetHostId=null;
        initPeer(S.id, null);
    } else {
        const hid = document.getElementById('join-id-input').value.trim().replace(/[^a-zA-Z0-9-_]/g,'');
        if (!hid) { resetUI('Enter a Room ID'); return; }
        S.id = genId(); S.targetHostId = hid;
        initPeer(S.id, hid);
    }
}

// â”€â”€â”€ PeerJS init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function makePeerConfig(iceConfig) {
    // Always use peerjs cloud signaling; swap only the ICE servers
    return {
        host: '0.peerjs.com', port: 443, path: '/', secure: true,
        debug: 1,
        config: iceConfig
    };
}

function initPeer(myId, targetHostId) {
    const cfg = makePeerConfig(ICE_CONFIGS[iceIdx]);
    setStatus(`Connectingâ€¦ (ICE profile ${iceIdx+1}/${ICE_CONFIGS.length})`);
    log(`ICE[${iceIdx}]: ${JSON.stringify(ICE_CONFIGS[iceIdx].iceServers?.map(s=>s.urls)).slice(0,80)}â€¦`);

    try { peer = new Peer(myId, cfg); }
    catch(e) { log('new Peer() threw: '+e.message,'err'); tryNextIce(myId, targetHostId, e.message); return; }

    // Signaling server timeout (8 s)
    const sigTimeout = setTimeout(() => {
        if (!peer?.open) { log('signaling timeout','err'); tryNextIce(myId, targetHostId, 'Signaling server timeout'); }
    }, 8000);

    peer.on('open', id => {
        clearTimeout(sigTimeout);
        log(`peer.open âœ“  id=${id}`, 'ok');
        setStatus('Signaling OK â€” opening data channelâ€¦');

        if (targetHostId) {
            connectToHost(targetHostId);
        } else {
            onHostReady(id);
        }
    });

    peer.on('connection', conn => {
        if (S.mode!=='create') return;
        if (S.isLocked) { conn.on('open',()=>{conn.send({type:'error',msg:'Room locked.'});setTimeout(()=>conn.close(),500);}); return; }
        if (connections.length>=S.maxUsers) { conn.on('open',()=>{conn.send({type:'error',msg:'Room full.'});setTimeout(()=>conn.close(),500);}); return; }
        connections.push(conn);
        setupConn(conn);
        setTimeout(()=>{ if(conn.open){ conn.send({type:'sync-full',video:S.video,hostOnly:S.hostOnly,isLocked:S.isLocked}); broadcastUserList(); } },1000);
    });

    peer.on('error', err => {
        clearTimeout(sigTimeout);
        log(`peer error: ${err.type}`, 'err');
        if (err.type==='unavailable-id') { resetUI('Room ID taken. Try another.'); return; }
        if (err.type==='peer-unavailable') {
            if (retryCount < 3) { retryCount++; setStatus(`Host not found. Retry ${retryCount}/3â€¦`); setTimeout(()=>connectToHost(targetHostId||S.targetHostId),2000); }
            else resetUI('Host not found. Is the Room ID correct?');
            return;
        }
        tryNextIce(myId, targetHostId, err.type);
    });

    peer.on('disconnected', () => { log('peer disconnected, reconnectingâ€¦','wrn'); try { peer.reconnect(); } catch(e){} });
}

function tryNextIce(myId, targetHostId, reason) {
    if (peer) { try { peer.destroy(); } catch(e){} peer=null; }
    iceIdx++;
    if (iceIdx < ICE_CONFIGS.length) {
        log(`Switching to ICE profile ${iceIdx+1} (${reason})`, 'wrn');
        setStatus(`${reason} â€” trying backup relayâ€¦`);
        setTimeout(()=>initPeer(myId, targetHostId), 1500);
    } else {
        resetUI('All connection methods failed. Check your network or firewall.');
    }
}

// â”€â”€â”€ Host ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onHostReady(id) {
    document.getElementById('host-settings-group').classList.remove('hidden');
    userList = [{id, username:S.username, avatar:S.avatar, color:S.color, isCoHost:true}];
    enterApp(id); updateUserListUI();
}

// â”€â”€â”€ Guest: connect to host â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectToHost(hostId) {
    if (!peer?.open) { log('peer not ready, waitingâ€¦','wrn'); setTimeout(()=>connectToHost(hostId),500); return; }
    clearTimeout(connTimeout);
    setStatus(`Opening channel to "${hostId}"â€¦`);
    log(`peer.connect("${hostId}") ICE[${iceIdx}]`);

    try {
        hostConn = peer.connect(hostId, {
            metadata: {username:S.username, avatar:S.avatar, color:S.color},
            reliable: true,
            // Serialization as json is more compat across browsers
            serialization: 'json',
        });
    } catch(e) { log('peer.connect threw: '+e.message,'err'); resetUI('Connect failed: '+e.message); return; }

    // Data channel open timeout â€” this is the one you were hitting
    // We escalate the ICE profile instead of just retrying the same config
    connTimeout = setTimeout(() => {
        if (!hostConn?.open) {
            log(`hostConn open timeout (ICE[${iceIdx}])`, 'err');
            try { hostConn?.close(); } catch(e){}
            hostConn = null;
            if (iceIdx < ICE_CONFIGS.length - 1) {
                // Destroy peer and reinit with stronger ICE (TURN relay)
                if (peer) { try { peer.destroy(); } catch(e){} peer=null; }
                iceIdx++;
                log(`Escalating to ICE[${iceIdx}] with TURN relayâ€¦`, 'wrn');
                setStatus(`NAT blocked. Switching to relay serverâ€¦ (${iceIdx}/${ICE_CONFIGS.length})`);
                setTimeout(()=>initPeer(S.id, hostId), 1000);
            } else if (retryCount < 2) {
                retryCount++;
                setStatus(`Timeout. Retry ${retryCount}/2 with full TURN relayâ€¦`);
                setTimeout(()=>connectToHost(hostId), 1000);
            } else {
                resetUI('Cannot reach host. Try sharing the link on the same Wi-Fi, or ask host to retry.');
            }
        }
    }, 14000); // 14s â€” enough for TURN negotiation

    hostConn.on('open', () => {
        clearTimeout(connTimeout); retryCount=0;
        log('hostConn open âœ“', 'ok');
        addSysMsg('Joined room!');
        setupConn(hostConn);
        enterApp(hostId);
        document.getElementById('my-peer-id').textContent = hostId;
    });
    hostConn.on('close', () => { toast('Host disconnected','error'); setTimeout(()=>location.reload(),2000); });
    hostConn.on('error', e => {
        clearTimeout(connTimeout);
        log('hostConn error: '+e,'err');
        if (iceIdx < ICE_CONFIGS.length - 1) { iceIdx++; if(peer){try{peer.destroy();}catch(e){} peer=null;} initPeer(S.id, hostId); }
        else resetUI('Connection to host failed.');
    });
}

// â”€â”€â”€ Shared connection setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupConn(conn) {
    if (S.mode==='create' && conn.metadata) {
        const {username,avatar,color}=conn.metadata;
        userList.push({id:conn.peer,username,avatar,color,isCoHost:false});
        broadcastUserList();
        const msg=`${username} joined`;
        broadcast({type:'system',msg}); addSysMsg(msg); ping();
    }
    conn.on('data', d=>handleData(d,conn));
    conn.on('close', ()=>{
        if (S.mode==='create') {
            connections=connections.filter(c=>c!==conn);
            const i=userList.findIndex(u=>u.id===conn.peer);
            if (i!==-1) { const [u]=userList.splice(i,1); broadcastUserList(); const msg=`${u.username} left`; addSysMsg(msg); broadcast({type:'system',msg}); }
        }
    });
}

function enterApp(id) {
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('app-view').classList.remove('hidden');
    if (S.mode==='create') document.getElementById('my-peer-id').textContent=id;
    updateProfileUI(); initYT();
}
function updateProfileUI() {
    const el=document.getElementById('user-avatar-display');
    el.textContent=S.avatar; el.className=`w-8 h-8 rounded-full ${S.color} flex items-center justify-center text-sm cursor-pointer`;
}

// â”€â”€â”€ User list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function broadcastUserList() { broadcast({type:'user-list',list:userList}); updateUserListUI(); }
function updateUserListUI() {
    const c=document.getElementById('user-list-container');
    document.getElementById('user-count').textContent=userList.length;
    c.innerHTML='';
    userList.forEach(u=>{
        const isMe=u.id===(S.mode==='create'?S.id:peer?.id);
        const role=u.isCoHost?(u.id===S.id&&S.mode==='create'?'HOST':'CO-HOST'):'USER';
        let ctrl='';
        if (S.mode==='create'&&!isMe) ctrl=`<div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="promoteUser('${u.id}')" class="text-indigo-400 hover:text-white text-xs">â†‘</button><button onclick="kickUser('${u.id}')" class="text-red-400 hover:text-white text-xs">âœ•</button></div>`;
        const d=document.createElement('div');
        d.className='flex items-center justify-between p-2 rounded-lg hover:bg-slate-800/50 group';
        d.innerHTML=`<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${u.color} flex items-center justify-center text-sm">${u.avatar}</div><div><p class="text-xs font-bold text-slate-200">${u.username}${isMe?' <span class="text-[9px] bg-slate-700 px-1 rounded text-slate-400">YOU</span>':''}</p><p class="text-[9px] ${u.isCoHost?'text-indigo-400':'text-slate-500'}">${role}</p></div></div>${ctrl}`;
        c.appendChild(d);
    });
    lucide.createIcons();
}
function kickUser(id){const c=connections.find(c=>c.peer===id);if(c){c.send({type:'error',msg:'Kicked.'});setTimeout(()=>c.close(),500);}}
function promoteUser(id){const u=userList.find(u=>u.id===id);if(!u)return;u.isCoHost=!u.isCoHost;broadcastUserList();const c=connections.find(c=>c.peer===id);if(c)c.send({type:'promote',val:u.isCoHost});toast(`Updated ${u.username}`,'success');}

// â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleData(data,senderConn) {
    if(data.type==='error'){alert(data.msg);location.reload();return;}
    if(data.type==='chat'){addChat(data.user,data.msg,data.avatar,data.color);ping();if(S.mode==='create')broadcast(data,senderConn);if(document.getElementById('chat-sidebar').classList.contains('translate-x-full'))document.getElementById('chat-badge').classList.remove('hidden');}
    else if(data.type==='system'){addSysMsg(data.msg);if(S.mode==='create')broadcast(data,senderConn);}
    else if(data.type==='video-action'){if(S.mode==='create'&&S.hostOnly&&!data.isHost)return;applyVid(data.action,data.val);if(S.mode==='create')broadcast(data,senderConn);}
    else if(data.type==='sync-full'){S.hostOnly=data.hostOnly;updateLockUI(data.isLocked);if(data.video?.type==='youtube'){document.getElementById('url-input').value=`https://youtu.be/${data.video.src}`;S.video=data.video;loadVideo(true);}else if(data.video?.type==='file')addSysMsg('Host is watching a local file â€” load the same file.');if(data.video?.speed)changeSpeed(data.video.speed,true);}
    else if(data.type==='settings'){if(data.key==='hostOnly')S.hostOnly=data.val;if(data.key==='isLocked')updateLockUI(data.val);}
    else if(data.type==='user-list'){userList=data.list;updateUserListUI();}
    else if(data.type==='promote'){S.isCoHost=data.val;toast(S.isCoHost?'You are Co-Host':'Co-Host removed','info');}
    else if(data.type==='update-profile'){if(S.mode==='create'){const u=userList.find(u=>u.id===senderConn.peer);if(u){u.username=data.username;u.avatar=data.avatar;u.color=data.color;broadcastUserList();}}}
}
function broadcast(data,exclude=null){connections.forEach(c=>{if(c!==exclude&&c.open)c.send(data);});}

// â”€â”€â”€ Video â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initYT(){if(!window.YT){const t=document.createElement('script');t.src='https://www.youtube.com/iframe_api';document.body.appendChild(t);}}
function loadVideo(isRemote=false){const url=document.getElementById('url-input').value;const id=ytId(url);if(!id)return;S.video.type='youtube';S.video.src=id;activatePlayer('youtube');if(!S.ytPlayer){S.ytPlayer=new YT.Player('youtube-player',{height:'100%',width:'100%',videoId:id,playerVars:{autoplay:1,controls:0,rel:0},events:{onStateChange:onYTState}});}else{S.ytPlayer.loadVideoById(id);}if(!isRemote)sendVid('change',{type:'youtube',src:id});}
function handleFile(input){const f=input.files[0];if(!f)return;const url=URL.createObjectURL(f);if(S.ytPlayer?.stopVideo)S.ytPlayer.stopVideo();S.video.type='file';activatePlayer('html5');const v=document.getElementById('html5-player');v.src=url;v.playbackRate=S.video.speed;v.onplay=()=>sendVid('play',v.currentTime);v.onpause=()=>sendVid('pause',v.currentTime);v.onseeked=()=>sendVid('seek',v.currentTime);toast('File loaded','success');if(S.mode==='create')broadcast({type:'video-action',action:'change',val:{type:'file'}});input.value='';}
function onYTState(e){if(isSyncing)return;if(e.data==YT.PlayerState.PLAYING)sendVid('play',S.ytPlayer.getCurrentTime());if(e.data==YT.PlayerState.PAUSED)sendVid('pause',S.ytPlayer.getCurrentTime());}
function sendVid(action,val){if(isSyncing)return;if(S.mode!=='create'&&S.hostOnly&&!S.isCoHost){toast('Controls locked','error');return;}const d={type:'video-action',action,val,isHost:S.mode==='create'||S.isCoHost};if(action==='play')S.video.state='playing';if(action==='pause')S.video.state='paused';if(action==='seek')S.video.time=val;if(action==='speed')S.video.speed=val;if(S.mode==='create')broadcast(d);else if(hostConn?.open)hostConn.send(d);}
function applyVid(action,val){isSyncing=true;const yt=S.ytPlayer,h5=document.getElementById('html5-player');if(action==='change'){if(val.type==='youtube'){document.getElementById('url-input').value=`https://youtu.be/${val.src}`;loadVideo(true);}else addSysMsg('Host switched to local file.');}else if(action==='speed')changeSpeed(val,true);else if(S.video.type==='youtube'&&yt?.getPlayerState){if(action==='play'){if(Math.abs(yt.getCurrentTime()-val)>1)yt.seekTo(val);yt.playVideo();}if(action==='pause'){yt.seekTo(val);yt.pauseVideo();}if(action==='seek')yt.seekTo(val);}else if(S.video.type==='file'){if(action==='play'){if(Math.abs(h5.currentTime-val)>1)h5.currentTime=val;h5.play().catch(()=>{});}if(action==='pause'){h5.pause();h5.currentTime=val;}if(action==='seek')h5.currentTime=val;}setTimeout(()=>{isSyncing=false;},500);}
function seekRelative(s){if(S.mode!=='create'&&S.hostOnly&&!S.isCoHost){toast('Controls locked','error');return;}let t=0;if(S.video.type==='youtube'&&S.ytPlayer)t=S.ytPlayer.getCurrentTime();else if(S.video.type==='file')t=document.getElementById('html5-player').currentTime;const n=Math.max(0,t+s);sendVid('seek',n);if(S.video.type==='youtube')S.ytPlayer.seekTo(n);else document.getElementById('html5-player').currentTime=n;}
function activatePlayer(type){document.getElementById('placeholder').classList.add('hidden');const h5=document.getElementById('html5-player'),yt=document.getElementById('youtube-player');if(type==='youtube'){h5.classList.add('hidden');h5.pause();yt.style.display='block';}else{yt.style.display='none';if(S.ytPlayer?.pauseVideo)S.ytPlayer.pauseVideo();h5.classList.remove('hidden');}}
function ytId(url){const m=url.match(/(?:youtu\.be\/|watch\?v=|embed\/|v\/)([^#&?]{11})/);return m?m[1]:null;}
function changeSpeed(val,isRemote=false){const s=parseFloat(val);S.video.speed=s;document.getElementById('speed-select').value=s;document.getElementById('html5-player').playbackRate=s;if(S.ytPlayer?.setPlaybackRate)S.ytPlayer.setPlaybackRate(s);if(!isRemote)sendVid('speed',s);}
function handleSubtitle(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{let c=e.target.result;if(f.name.endsWith('.srt'))c='WEBVTT\n\n'+c.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g,'$1.$2');document.getElementById('player-track').src=URL.createObjectURL(new Blob([c],{type:'text/vtt'}));const tt=document.getElementById('html5-player').textTracks[0];if(tt)tt.mode='showing';toast('Subtitles loaded','success');};r.readAsText(f);}

// â”€â”€â”€ Chat & AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function askAI(q){const p=q||document.getElementById('chat-input').value.replace('@ai','').trim();if(!p)return;if(!apiKey)return toast('API Key needed','error');sendChat(null,p);toast('Thinkingâ€¦','info');try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:'Short fun response: '+p}]}]})});const d=await r.json();const t=d.candidates?.[0]?.content?.parts?.[0]?.text||'Failed.';const m={type:'chat',msg:t,user:'AI',avatar:'âœ¨',color:'bg-purple-600'};addChat('AI',t,'âœ¨','bg-purple-600');ping();if(S.mode==='create')broadcast(m);else if(hostConn?.open)hostConn.send(m);}catch(e){toast('AI Error','error');}}
function sendChat(e,manual=null){if(e)e.preventDefault();const inp=document.getElementById('chat-input');const msg=manual||inp.value.trim();if(!msg)return;if(msg.startsWith('@ai')&&!manual){askAI(msg.replace('@ai','').trim());inp.value='';return;}const d={type:'chat',msg,user:S.username,avatar:S.avatar,color:S.color};addChat(S.username,msg,S.avatar,S.color,true);ping();if(S.mode==='create')broadcast(d);else if(hostConn?.open)hostConn.send(d);inp.value='';}
function sendEmoji(e){sendChat(null,e);}
function addChat(user,msg,avatar,color,isMe=false){const b=document.getElementById('chat-container'),d=document.createElement('div');d.className=`flex gap-3 ${isMe?'flex-row-reverse':''}`;d.innerHTML=`<div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-xs shrink-0 text-white">${avatar}</div><div class="${isMe?'bg-indigo-600 text-white':'bg-[#1f2937] text-slate-200'} p-3 rounded-2xl text-sm max-w-[85%]"><p class="text-[9px] opacity-70 mb-1 font-bold uppercase">${user}</p><p>${msg}</p></div>`;b.appendChild(d);b.scrollTop=b.scrollHeight;}
function addSysMsg(t){const b=document.getElementById('chat-container'),d=document.createElement('div');d.className='text-center text-[10px] text-slate-500 my-2';d.textContent=t;b.appendChild(d);b.scrollTop=b.scrollHeight;}

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSettings(){const m=document.getElementById('settings-modal');if(m.open)m.close();else m.showModal();}
function toggleMobileChat(){const s=document.getElementById('chat-sidebar');if(s.classList.contains('translate-x-full')){s.classList.remove('translate-x-full');document.getElementById('chat-badge').classList.add('hidden');}else s.classList.add('translate-x-full');}
function toggleFullscreen(){const e=document.getElementById('video-box');if(!document.fullscreenElement)e.requestFullscreen().catch(()=>{});else document.exitFullscreen();}
function switchTab(t){const cc=document.getElementById('view-chat'),cu=document.getElementById('view-users'),tc=document.getElementById('tab-chat'),tu=document.getElementById('tab-users');if(t==='chat'){cc.classList.remove('hidden');cu.classList.add('hidden');tc.className='w-1/2 py-3 text-xs font-bold text-indigo-400 border-b-2 border-indigo-500';tu.className='w-1/2 py-3 text-xs font-bold text-slate-500 flex items-center justify-center gap-1';}else{cc.classList.add('hidden');cu.classList.remove('hidden');tu.className='w-1/2 py-3 text-xs font-bold text-indigo-400 border-b-2 border-indigo-500';tc.className='w-1/2 py-3 text-xs font-bold text-slate-500';}}
function saveSettings(){const n=document.getElementById('modal-username').value;apiKey=document.getElementById('ai-api-key').value;if(n)S.username=n;localStorage.setItem('nw_profile',JSON.stringify({name:S.username,avatar:S.avatar,color:S.color,apiKey}));if(S.mode==='create'){const me=userList.find(u=>u.id===S.id);if(me){me.username=n;me.avatar=S.avatar;me.color=S.color;}broadcastUserList();updateProfileUI();}else if(hostConn?.open){hostConn.send({type:'update-profile',username:S.username,avatar:S.avatar,color:S.color});updateProfileUI();}toggleSettings();toast('Saved âœ“','success');}
function toggleHostOnly(){if(S.mode!=='create')return;S.hostOnly=!S.hostOnly;const b=document.getElementById('btn-host-only'),k=b.firstElementChild;b.classList.toggle('bg-indigo-600',S.hostOnly);b.classList.toggle('bg-slate-700',!S.hostOnly);k.classList.toggle('translate-x-5',S.hostOnly);broadcast({type:'settings',key:'hostOnly',val:S.hostOnly});}
function toggleRoomLock(){if(S.mode!=='create')return;S.isLocked=!S.isLocked;updateLockUI(S.isLocked);const b=document.getElementById('btn-lock-room'),k=b.firstElementChild;b.classList.toggle('bg-indigo-600',S.isLocked);b.classList.toggle('bg-slate-700',!S.isLocked);k.classList.toggle('translate-x-5',S.isLocked);broadcast({type:'settings',key:'isLocked',val:S.isLocked});}
function updateLockUI(l){document.getElementById('room-locked-indicator').classList.toggle('hidden',!l);}
function copyId(){const id=document.getElementById('my-peer-id').textContent;if(id==='...')return;navigator.clipboard.writeText(id).then(()=>toast('Copied! Share this ID âœ“','success'));}
function toast(msg,type='info'){const c=document.getElementById('toast-container'),d=document.createElement('div');const cl=type==='success'?'bg-emerald-900/90 border-emerald-500/50':type==='error'?'bg-red-900/90 border-red-500/50':'bg-slate-900/90 border-slate-700';d.className=`${cl} border text-white px-4 py-3 rounded-xl text-xs font-bold shadow-2xl backdrop-blur flex items-center gap-2`;d.textContent=(type==='success'?'âœ“ ':type==='error'?'âœ• ':'')+msg;c.appendChild(d);setTimeout(()=>d.remove(),3500);}
</script>
</body>
</html>
