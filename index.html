<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZG WatchTogether | P2P</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PeerJS (Networking) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --bg-dark: #0f172a; --primary: #3b82f6; }
        body { background-color: var(--bg-dark); color: #e2e8f0; font-family: sans-serif; overflow: hidden; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; background: black; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); }
        .video-container iframe, .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .avatar-option.selected { transform: scale(1.1); border: 2px solid #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Login View -->
    <div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://images.unsplash.com/photo-1536440136628-849c177e76a1?q=80&w=2525&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm"></div>
        <div class="relative bg-slate-800/90 border border-slate-700 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg"><i data-lucide="monitor-play" class="text-white w-8 h-8"></i></div>
                <h1 class="text-2xl font-bold text-white">ZG WatchTogether</h1>
                <p class="text-slate-400 text-sm">Serverless P2P Sync</p>
            </div>

            <!-- Avatar Selector -->
            <div class="flex justify-center gap-3 mb-6">
                <div class="avatar-option w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center cursor-pointer" onclick="selectAvatar('üëæ', 'bg-blue-600')">üëæ</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center cursor-pointer" onclick="selectAvatar('üê±', 'bg-purple-600')">üê±</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center cursor-pointer" onclick="selectAvatar('ü§ñ', 'bg-emerald-600')">ü§ñ</div>
                <div class="avatar-option w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center cursor-pointer" onclick="selectAvatar('ü¶ä', 'bg-orange-600')">ü¶ä</div>
            </div>

            <div class="space-y-4">
                <input type="text" id="username-input" placeholder="Your Name" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none">
                
                <div class="flex border-b border-slate-700 pb-2 mb-2">
                    <button onclick="switchMode('create')" id="btn-mode-create" class="flex-1 text-sm font-bold text-blue-400 border-b-2 border-blue-500 pb-2">Create Room</button>
                    <button onclick="switchMode('join')" id="btn-mode-join" class="flex-1 text-sm font-bold text-slate-500 pb-2">Join Room</button>
                </div>

                <div id="join-input-group" class="hidden">
                    <input type="text" id="room-id-input" placeholder="Paste Host ID here..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none">
                </div>

                <button onclick="handleStart()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition" id="action-btn">Start Hosting</button>
                <p id="status-msg" class="text-center text-xs text-slate-400 h-4"></p>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="flex flex-col h-full hidden">
        <header class="h-16 border-b border-slate-700 flex items-center justify-between px-4 bg-slate-900 z-20">
            <div class="flex items-center gap-3">
                <i data-lucide="monitor-play" class="text-blue-500 w-6 h-6"></i>
                <div>
                    <h1 class="font-bold text-white">WatchTogether</h1>
                    <p class="text-[10px] text-slate-400 flex items-center gap-1">
                        ID: <span id="my-peer-id" class="font-mono text-blue-400 select-all cursor-pointer" onclick="copyId()">...</span>
                        <i data-lucide="copy" class="w-3 h-3 cursor-pointer hover:text-white" onclick="copyId()"></i>
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="peer-status" class="px-3 py-1 rounded-full bg-slate-800 text-xs font-medium text-slate-400 border border-slate-700 flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div> Waiting...
                </div>
                <div id="user-avatar-display" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold">?</div>
            </div>
        </header>

        <main class="flex-1 flex overflow-hidden">
            <!-- Left: Video -->
            <div class="flex-1 flex flex-col bg-black relative">
                <!-- Controls Overlay -->
                <div class="absolute top-0 left-0 w-full p-4 z-20 opacity-0 hover:opacity-100 transition duration-300 bg-gradient-to-b from-black/80 to-transparent">
                    <div class="flex justify-center gap-2">
                        <input type="text" id="url-input" placeholder="YouTube or .mp4 link" class="bg-slate-900/90 border border-slate-700 text-xs px-3 py-2 rounded-lg w-64 text-white focus:border-blue-500 outline-none">
                        <button onclick="loadVideo()" class="bg-blue-600 px-3 rounded-lg text-xs font-bold text-white">Play</button>
                        <button onclick="document.getElementById('file-input').click()" class="bg-slate-700 px-3 rounded-lg text-xs text-white">File</button>
                        <input type="file" id="file-input" class="hidden" accept="video/*" onchange="handleFile(this)">
                    </div>
                </div>

                <!-- Video Stage -->
                <div class="flex-1 flex items-center justify-center p-4">
                    <div class="w-full max-w-5xl video-container shadow-2xl relative">
                        <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-slate-500">
                            <i data-lucide="film" class="w-12 h-12 mb-2"></i>
                            <p>Waiting for video...</p>
                        </div>
                        <video id="html5-player" class="hidden" controls playsinline></video>
                        <div id="youtube-player" class="hidden"></div>
                    </div>
                </div>
                
                <!-- Webcams (Bottom) -->
                <div class="h-32 bg-slate-950 border-t border-slate-800 flex items-center px-4 gap-4 overflow-x-auto shrink-0">
                    <div class="relative w-40 h-24 bg-black rounded-lg border border-slate-700 shrink-0 overflow-hidden">
                        <video id="my-webcam" autoplay muted playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
                        <div class="absolute bottom-1 left-1 bg-black/60 px-2 rounded text-[10px] text-white">YOU</div>
                        <div class="absolute inset-0 flex items-center justify-center gap-2 opacity-0 hover:opacity-100 bg-black/40 transition">
                            <button onclick="toggleCam()" class="p-1.5 bg-slate-700 rounded-full hover:bg-slate-600 text-white"><i data-lucide="video" class="w-4 h-4"></i></button>
                            <button onclick="toggleMic()" class="p-1.5 bg-slate-700 rounded-full hover:bg-slate-600 text-white"><i data-lucide="mic" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <!-- Remote streams will be appended here -->
                    <div id="remote-streams" class="flex gap-4"></div>
                </div>
            </div>

            <!-- Right: Chat -->
            <div class="w-80 bg-slate-900 border-l border-slate-800 flex flex-col">
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                <form onsubmit="sendChat(event)" class="p-3 bg-slate-800/50 border-t border-slate-700">
                    <input id="chat-input" type="text" placeholder="Type a message..." class="w-full bg-slate-950 border border-slate-700 rounded-lg py-2 px-3 text-xs text-white focus:border-blue-500 outline-none">
                </form>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG ---
        // Generates a random ID for PeerJS cloud
        const generateId = () => Math.random().toString(36).substring(2, 7);
        
        let peer;
        let connections = []; // For Host: list of guests
        let hostConn = null;  // For Guest: connection to host
        
        const state = {
            mode: 'create', // 'create' or 'join'
            id: null,
            username: 'Guest',
            avatar: 'üëæ',
            color: 'bg-blue-600',
            stream: null,
            video: { type: null, src: null, time: 0, state: 'paused' },
            ytPlayer: null
        };

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            const lastProf = localStorage.getItem('zg_p2p_profile');
            if(lastProf) {
                const p = JSON.parse(lastProf);
                document.getElementById('username-input').value = p.name;
                selectAvatar(p.avatar, p.color);
            }
            initWebcam();
            
            // Check URL for join ID
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('join')) {
                switchMode('join');
                document.getElementById('room-id-input').value = urlParams.get('join');
            }
        };

        // --- AUTH / PEER SETUP ---
        function switchMode(mode) {
            state.mode = mode;
            const btnCreate = document.getElementById('btn-mode-create');
            const btnJoin = document.getElementById('btn-mode-join');
            const joinInput = document.getElementById('join-input-group');
            const actionBtn = document.getElementById('action-btn');

            if(mode === 'create') {
                btnCreate.className = 'flex-1 text-sm font-bold text-blue-400 border-b-2 border-blue-500 pb-2';
                btnJoin.className = 'flex-1 text-sm font-bold text-slate-500 pb-2';
                joinInput.classList.add('hidden');
                actionBtn.innerText = "Start Hosting";
                actionBtn.classList.replace('bg-emerald-600', 'bg-blue-600');
            } else {
                btnJoin.className = 'flex-1 text-sm font-bold text-emerald-400 border-b-2 border-emerald-500 pb-2';
                btnCreate.className = 'flex-1 text-sm font-bold text-slate-500 pb-2';
                joinInput.classList.remove('hidden');
                actionBtn.innerText = "Join Room";
                actionBtn.classList.replace('bg-blue-600', 'bg-emerald-600');
            }
        }

        function selectAvatar(av, col) {
            state.avatar = av; state.color = col;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            // Visual selection logic would go here
        }

        async function handleStart() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return alert("Please enter a name");
            state.username = name;
            localStorage.setItem('zg_p2p_profile', JSON.stringify({name, avatar: state.avatar, color: state.color}));

            document.getElementById('action-btn').disabled = true;
            document.getElementById('status-msg').innerText = "Connecting to P2P Cloud...";

            if(state.mode === 'create') {
                state.id = generateId();
                initPeer(state.id);
            } else {
                const hostId = document.getElementById('room-id-input').value.trim();
                if(!hostId) return alert("Enter Host ID");
                state.id = generateId(); // Guests also need an ID
                initPeer(state.id, hostId);
            }
        }

        function initPeer(myId, targetHostId = null) {
            peer = new Peer(myId, { debug: 1 });

            peer.on('open', (id) => {
                enterApp(id);
                if(targetHostId) connectToHost(targetHostId);
                else {
                    setStatus("Hosting", "bg-blue-500");
                    addSystemMsg(`Room Created. Share ID: ${id}`);
                }
            });

            peer.on('connection', (conn) => {
                if(state.mode === 'create') {
                    // I am Host, Guest connected
                    connections.push(conn);
                    setupConnection(conn);
                    addSystemMsg("A user connected!");
                    // Send current state
                    setTimeout(() => {
                        conn.send({ type: 'sync-full', video: state.video });
                    }, 1000);
                } else {
                    // Guests shouldn't really accept random connections in this simple model
                }
            });

            peer.on('error', (err) => {
                console.error(err);
                alert("Connection Error: " + err.type);
                location.reload();
            });
        }

        function connectToHost(hostId) {
            hostConn = peer.connect(hostId);
            setStatus("Connecting...", "bg-yellow-500");
            
            hostConn.on('open', () => {
                setStatus("Connected to Host", "bg-emerald-500");
                addSystemMsg("Joined Room!");
                setupConnection(hostConn);
            });
            
            hostConn.on('error', e => alert("Could not connect to host"));
        }

        function setupConnection(conn) {
            conn.on('data', (data) => {
                handleData(data, conn);
            });
            conn.on('close', () => {
                if(state.mode === 'create') {
                    connections = connections.filter(c => c !== conn);
                    addSystemMsg("User disconnected");
                } else {
                    alert("Host disconnected. Room closed.");
                    location.reload();
                }
            });
        }

        function enterApp(id) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('my-peer-id').innerText = id;
            document.getElementById('user-avatar-display').innerText = state.avatar;
            document.getElementById('user-avatar-display').className = `w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${state.color}`;
            initYouTube();
        }

        // --- DATA HANDLING ---
        function handleData(data, senderConn) {
            console.log("Received:", data);
            
            if(data.type === 'chat') {
                addChat(data.user, data.msg, data.avatar, data.color);
                // If I am host, broadcast to others
                if(state.mode === 'create') broadcast(data, senderConn);
            }
            else if (data.type === 'video-action') {
                applyVideoAction(data.action, data.val);
                // If Host, broadcast
                if(state.mode === 'create') broadcast(data, senderConn);
            }
            else if (data.type === 'sync-full') {
                // Initial Sync for Guest
                if(data.video.type === 'youtube') {
                    document.getElementById('url-input').value = `https://youtu.be/${data.video.src}`;
                    loadVideo(true); // true = remote
                }
            }
        }

        function broadcast(data, excludeConn = null) {
            connections.forEach(c => {
                if(c !== excludeConn && c.open) c.send(data);
            });
        }

        // --- VIDEO LOGIC ---
        function initYouTube() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.body.appendChild(tag);
        }

        function loadVideo(isRemote = false) {
            const url = document.getElementById('url-input').value;
            const ytId = extractYouTubeId(url);
            
            if(ytId) {
                state.video = { type: 'youtube', src: ytId, time: 0, state: 'paused' };
                activatePlayer('youtube');
                if(!state.ytPlayer) {
                    state.ytPlayer = new YT.Player('youtube-player', {
                        height: '100%', width: '100%', videoId: ytId,
                        playerVars: { autoplay: 1, controls: 0 },
                        events: { onStateChange: onPlayerStateChange }
                    });
                } else {
                    state.ytPlayer.loadVideoById(ytId);
                }
                if(!isRemote) sendVideoAction('change', { type: 'youtube', src: ytId });
            }
        }

        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            const url = URL.createObjectURL(file);
            
            state.video = { type: 'file', src: null, time: 0, state: 'paused' }; // src null because blobs are local
            activatePlayer('html5');
            const v = document.getElementById('html5-player');
            v.src = url;
            
            // Listeners
            v.onplay = () => sendVideoAction('play', v.currentTime);
            v.onpause = () => sendVideoAction('pause', v.currentTime);
            v.onseeked = () => sendVideoAction('seek', v.currentTime);
            
            // Note: Cannot sync actual file bits P2P easily in browser without huge data usage.
            // We assume users have same file or we just sync timing "blindly".
            addSystemMsg("Local file loaded. Syncing time only.");
        }

        function onPlayerStateChange(e) {
            // Prevent loops by checking who initiated
            if(e.data == YT.PlayerState.PLAYING) sendVideoAction('play', state.ytPlayer.getCurrentTime());
            if(e.data == YT.PlayerState.PAUSED) sendVideoAction('pause', state.ytPlayer.getCurrentTime());
        }

        function sendVideoAction(action, val) {
            const data = { type: 'video-action', action, val };
            if(state.mode === 'create') broadcast(data);
            else if(hostConn && hostConn.open) hostConn.send(data);
        }

        function applyVideoAction(action, val) {
            const yt = state.ytPlayer;
            const h5 = document.getElementById('html5-player');
            
            if(state.video.type === 'youtube' && yt) {
                if(action === 'play') {
                    if(Math.abs(yt.getCurrentTime() - val) > 1) yt.seekTo(val);
                    yt.playVideo();
                }
                if(action === 'pause') yt.pauseVideo();
                if(action === 'seek') yt.seekTo(val);
                if(action === 'change') {
                    document.getElementById('url-input').value = `https://youtu.be/${val.src}`;
                    loadVideo(true);
                }
            } else if (state.video.type === 'file' || !state.video.type) {
                // If generic or file
                if(action === 'play') { h5.currentTime = val; h5.play().catch(e=>{}); }
                if(action === 'pause') h5.pause();
                if(action === 'seek') h5.currentTime = val;
            }
        }

        function activatePlayer(type) {
            document.getElementById('placeholder').classList.add('hidden');
            const h5 = document.getElementById('html5-player');
            const yt = document.getElementById('youtube-player');
            if(type === 'youtube') { h5.classList.add('hidden'); yt.style.display = 'block'; }
            else { yt.style.display = 'none'; h5.classList.remove('hidden'); }
        }

        function extractYouTubeId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- CHAT & UI ---
        function sendChat(e) {
            e.preventDefault();
            const inp = document.getElementById('chat-input');
            const msg = inp.value.trim();
            if(!msg) return;
            
            const data = { type: 'chat', msg, user: state.username, avatar: state.avatar, color: state.color };
            addChat(state.username, msg, state.avatar, state.color, true); // Show local
            
            if(state.mode === 'create') broadcast(data);
            else if(hostConn) hostConn.send(data);
            
            inp.value = '';
        }

        function addChat(user, msg, avatar, color, isMe=false) {
            const box = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex gap-2 ${isMe ? 'flex-row-reverse' : ''}`;
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-xs shrink-0">${avatar}</div>
                <div class="${isMe ? 'bg-blue-600' : 'bg-slate-800'} p-2 rounded-lg text-sm max-w-[80%]">
                    <p class="text-[10px] opacity-70 mb-0.5">${user}</p>
                    <p>${msg}</p>
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function addSystemMsg(text) {
            const box = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "text-center text-[10px] text-slate-500 my-2 bg-slate-800/50 py-1 rounded";
            div.innerText = text;
            box.appendChild(div);
        }

        // --- WEBCAM (Local Only for Demo/P2P Mesh is complex for 1 file) ---
        // * Note: To sync webcams via P2P Mesh in 1 file requires `peer.call` logic
        // * For this scope, we keep local preview active.
        async function initWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('my-webcam').srcObject = stream;
                state.stream = stream;
            } catch(e) { console.log("Cam error", e); }
        }
        function toggleCam() {
            if(state.stream) state.stream.getVideoTracks()[0].enabled = !state.stream.getVideoTracks()[0].enabled;
        }
        function toggleMic() {
            if(state.stream) state.stream.getAudioTracks()[0].enabled = !state.stream.getAudioTracks()[0].enabled;
        }

        // --- UTILS ---
        function setStatus(text, colorClass) {
            const el = document.getElementById('peer-status');
            el.innerHTML = `<div class="w-2 h-2 rounded-full ${colorClass} animate-pulse"></div> ${text}`;
        }
        function copyId() {
            const id = document.getElementById('my-peer-id').innerText;
            navigator.clipboard.writeText(id).then(() => alert("ID Copied!"));
            // Update URL for easy sharing
            const url = window.location.origin + window.location.pathname + '?join=' + id;
            console.log("Share URL:", url);
        }

    </script>
</body>
</html>
